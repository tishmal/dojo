version: '3.8'

# ============================================
# Сети
# ============================================
networks:
  dojo-network:
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  pgdata:
    driver: local

# ============================================
# Сервисы
# ============================================
services:
  # ------------------------------------------
  # PostgreSQL База данных
  # ------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: dojo_postgres
    restart: unless-stopped
    networks:
      - dojo-network
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-dojo}
      POSTGRES_USER: ${POSTGRES_USER:-dojo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dev_password}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-dojo}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ------------------------------------------
  # Go Backend API (Development)
  # ------------------------------------------
  api-dev:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: development  # Используем стадию development
    container_name: dojo_api_dev
    profiles: ["dev"]  # Запускается только с профилем dev
    restart: unless-stopped
    networks:
      - dojo-network
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-dojo}:${POSTGRES_PASSWORD:-dev_password}@postgres:5432/${POSTGRES_DB:-dojo}?sslmode=disable
      PORT: ${API_PORT:-8080}
      ENV: development
      BOT_TOKEN: ${BOT_TOKEN:-}
      JWT_SECRET: ${JWT_SECRET:-dev_jwt_secret}
    ports:
      - "${API_PORT:-8080}:8080"
    volumes:
      # Монтируем код для hot-reload
      - ./backend:/app
      # Исключаем vendor и временные файлы
      - /app/vendor
      - /app/tmp
    command: air -c .air.toml

  # ------------------------------------------
  # Go Backend API (Production)
  # ------------------------------------------
  api-prod:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production  # Используем стадию production
    container_name: dojo_api_prod
    profiles: ["prod"]  # Запускается только с профилем prod
    restart: always
    networks:
      - dojo-network
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-dojo}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-dojo}?sslmode=disable
      PORT: ${API_PORT:-8080}
      ENV: production
      BOT_TOKEN: ${BOT_TOKEN}
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "${API_PORT:-8080}:8080"
    # Для production НЕ монтируем код

  # ------------------------------------------
  # pgAdmin (опционально, для управления БД)
  # ------------------------------------------
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: dojo_pgadmin
    profiles: ["tools"]  # Запускается только с профилем tools
    restart: unless-stopped
    networks:
      - dojo-network
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@dojo.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    volumes:
      - ./pgadmin-data:/var/lib/pgadmin
    depends_on:
      - postgres

  # ------------------------------------------
  # Nginx (для production, раздает статику)
  # ------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: dojo_nginx
    profiles: ["prod"]
    restart: always
    networks:
      - dojo-network
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_SSL_PORT:-443}:443"
    volumes:
      - ./frontend/dist:/usr/share/nginx/html:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - api-prod